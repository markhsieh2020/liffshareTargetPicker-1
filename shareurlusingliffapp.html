<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share url using LIFF App</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.3.0/sdk.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div class="container mt-3">
        <form class="form-group">
            <input name="shareUrl" type="url" id="sharedUrl" class="searchField form-control" />
        </form>
        <!-- ACTION BUTTON -->
        <center>
            <button id="getPreviewButton" class="btn btn-primary">預覽</button>
            <button id="shareTargetPicker" class="btn btn-primary">分享好友</button>
            <button id="directSendMessage" class="btn btn-info">直接發送</button>
            <button id="liffLoginButton" class="btn btn-success">LINE 登入</button>
            <button id="liffLogoutButton" class="btn btn-warning"  style="display: none;">LINE 登出</button>
        </center>
        <div id="shareTargetPickerMessage"></div>
    </div>
    <!-- PREVIEW INFO -->
    <div id="previewInfo" class="container" style="display: none;">
        <div id="previewPictureDiv" class="card">
            <img id="image" src="" class="card-img-top" alt="Load image failed">
            <div class="card-body">
                <h5 id="title" class="card-title"></h5>
                <p id="description" class="card-text"></p>
            </div>
        </div>
    </div>
    <div id="statusMessage">
        <div id="isInClientMessage"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/non-ios-extensions.js" type="text/javascript"></script>
    <script>
        var _title = "";
        var _description = "";
        var _image = "";
        var _url = "";
        var _aspectRatio = "20:13";
        var userDisplayName = "";
        var userPictureUrl = "";

        function initializeLiff(myLiffId) {
            liff
                .init({
                    liffId: myLiffId
                })
                .then(() => {
                    //start to use LIFF's api
                    initializeApp();
                })
                .catch((err) => {
                    console.log('error:' + err);
                });
        }

        function initializeLiffOrDie(myLiffId) {
            if (!myLiffId) {
            } else {
                initializeLiff(myLiffId);
            }
        }

        function previewUrlInfo(url, isAutoSend = false) {
            const cors = 'https://cors-anywhere.herokuapp.com/';
            //handle facebook no preview issue
            var oldUrl = new URL(url);
            if (oldUrl.hostname.includes('facebook')) {
                oldUrl.hostname = 'mobile.facebook.com';
            }

            //console.log('url:' + oldUrl.href);
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "application/x-www-form-urlencoded");

            var urlencoded = new URLSearchParams();
            urlencoded.append("url", oldUrl.href);

            var requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: urlencoded,
                redirect: 'follow'
            };

            fetch(cors + 'https://www.iaunty.com/parse', requestOptions)
                .then(response => response.json())
                .then(result => {
                    //console.log(result);

                    _title = result.Title;
                    _description = result.Description;
                    _image = result.Image;
                    _url = url;

                    document.getElementById('title').textContent = _title;
                    document.getElementById('description').textContent = _description;

                    const previewPictureDiv = document.getElementById('previewPictureDiv');

                    if (!_image) {
                        const bold = document.createElement('b');
                        bold.innerText = 'No Image!';
                        previewPictureDiv.appendChild(bold);

                    } else {
                        _image = _image.replace('http://', 'https://');
                        const img = document.getElementById('image');
                        img.classList.add("card-img-top");
                        img.onload = function () {
                            console.log(this.width + 'x' + this.height);
                            _aspectRatio = this.width + ":" + this.height;

                        }
                        img.src = _image;
                        img.alt = 'Preview Picture';
                    }

                    togglePreviewData();
                    document.getElementById('previewInfo').style.display = 'block';
                })
                .catch(error => console.log('error', error));
        }

        function sendFlexMessage() {
            if (!_title && !_description && !_image) return;

            liff.shareTargetPicker([
                createFlexMessageData(_title, _description, _image, _url, _aspectRatio)
            ]
            ).then(function (res) {
                liff.closeWindow();
            }).catch(function (res) {
                document.getElementById('shareTargetPickerMessage').textContent = "Sending Failed:" + JSON.stringify(res);
            });
        }

        function directSendFlexMessage() {
            if (!_title && !_description && !_image) return;

            liff.sendMessages([
                createFlexMessageData(_title, _description, _image, _url, _aspectRatio)
            ]
            ).then(function (res) {
                liff.closeWindow();
            }).catch(function (res) {
                document.getElementById('shareTargetPickerMessage').textContent = "Sending Failed:" + JSON.stringify(res);
            });
        }

        function createFlexMessageData(title, description, image, url, aspectRatio) {

            var myFlexContent = {
                "type": "bubble",
                "size": "giga",
                "header": {
                    "type": "box",
                    "layout": "horizontal",
                    "height": "82px",
                    "offsetBottom": "none",
                    "offsetTop": "none",
                    "spacing": "none",
                    "offsetStart": "none",
                    "paddingAll": "xl",
                    "action": {
                        "type": "uri",
                        "label": "前往",
                        "uri": url
                    },
                    "contents": []
                },
                "hero": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [],
                    "borderWidth": "2px",
                    "borderColor": "#ffffff",
                    "cornerRadius": "6px"
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": []
                }
            };

            if (userPictureUrl) {
                var userPicture = {
                    "type": "box",
                    "layout": "vertical",
                    "height": "48px",
                    "paddingAll": "none",
                    "margin": "none",
                    "spacing": "none",
                    "offsetStart": "none",
                    "width": "48px",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "vertical",
                            "borderWidth": "2px",
                            "borderColor": "#954db3",
                            "cornerRadius": "50px",
                            "contents": [
                                {
                                    "type": "image",
                                    "url": userPictureUrl,
                                    "size": "full",
                                    "aspectMode": "cover"
                                }
                            ]
                        }
                    ]
                }


                myFlexContent.header.contents.push(userPicture);
            }

            if (userDisplayName) {
                var userName = {
                    "type": "box",
                    "layout": "vertical",
                    "offsetStart": "md",
                    "spacing": "md",
                    "offsetTop": "none",
                    "paddingAll": "none",
                    "paddingStart": "none",
                    "contents": [
                        {
                            "type": "text",
                            "text": userDisplayName + "分享金牌月嫂",
                            "size": "md"
                        }
                    ]
                }


                userName.contents.push({
                    "type": "text",
                    "text": dayjs().format('M月D日 HH:mm'),
                    "size": "xs",
                    "offsetStart": "none",
                    "color": "#b7b7b7"
                });

                myFlexContent.header.contents.push(userName);
            }

            if (_image) {
                myFlexContent.hero = {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "image",
                            "url": image,
                            "size": "full",
                            "aspectRatio": aspectRatio,
                            "aspectMode": "cover",
                            "action": {
                                "type": "uri",
                                "uri": url
                            }
                        }
                    ],
                    "borderWidth": "2px",
                    "borderColor": "#ffffff",
                    "cornerRadius": "6px"
                }
            };

            if (_title) {
                myFlexContent.body.contents.push({
                    "type": "text",
                    "text": title,
                    "weight": "bold",
                    "size": "md",
                    "wrap": true,
                    "maxLines": 3
                });
            }

            if (_description) {
                myFlexContent.body.contents.push({
                    "type": "box",
                    "layout": "vertical",
                    "margin": "lg",
                    "spacing": "sm",
                    "contents": [
                        {
                            "type": "box",
                            "layout": "baseline",
                            "spacing": "sm",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": description,
                                    "wrap": true,
                                    "color": "#666666",
                                    "size": "xxs",
                                    "flex": 5,
                                    "maxLines": 7
                                }
                            ]
                        },
                        {
                            "type": "separator"
                        },
                        {
                            "type": "box",
                            "layout": "horizontal",
                            "margin": "xxl",
                            "spacing": "none",
                            "contents": [
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "type": "filler"
                                        },
                                        {
                                            "type": "box",
                                            "layout": "baseline",
                                            "contents": [
                                                {
                                                    "type": "filler"
                                                },
                                                {
                                                    "type": "icon",
                                                    "url": "https://i.imgur.com/IFjR25G.png"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "分享",
                                                    "flex": 0,
                                                    "offsetTop": "-2px"
                                                },
                                                {
                                                    "type": "filler"
                                                }
                                            ],
                                            "spacing": "sm"
                                        },
                                        {
                                            "type": "filler"
                                        }
                                    ],
                                    "margin": "xxl",
                                    "borderWidth": "1px",
                                    "borderColor": "#954db3",
                                    "height": "40px",
                                    "spacing": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "action",
                                        "uri": "https://liff.line.me/1573344717-916lVwEz"
                                    }
                                },
                                {
                                    "type": "box",
                                    "layout": "vertical",
                                    "contents": [
                                        {
                                            "type": "filler"
                                        },
                                        {
                                            "type": "box",
                                            "layout": "baseline",
                                            "contents": [
                                                {
                                                    "type": "filler"
                                                },
                                                {
                                                    "type": "icon",
                                                    "url": "https://i.imgur.com/tg4zN4R.png"
                                                },
                                                {
                                                    "type": "text",
                                                    "text": "開啟",
                                                    "flex": 0,
                                                    "offsetTop": "-2px"
                                                },
                                                {
                                                    "type": "filler"
                                                }
                                            ],
                                            "spacing": "sm"
                                        },
                                        {
                                            "type": "filler"
                                        }
                                    ],
                                    "margin": "xxl",
                                    "borderWidth": "1px",
                                    "borderColor": "#954db3",
                                    "height": "40px",
                                    "spacing": "sm",
                                    "action": {
                                        "type": "uri",
                                        "label": "action",
                                        "uri": url
                                    }
                                }
                            ]
                        }
                    ]
                });
            }

            var flex = {
                "type": "flex",
                "altText": _title,
                "contents": myFlexContent,
            };

            return flex;
        }

        function toggleElement(elementId) {
            const elem = document.getElementById(elementId);
            if (elem.offsetWidth > 0 && elem.offsetHeight > 0) {
                elem.style.display = 'none';
            } else {
                elem.style.display = 'block';
            }
        }

        function togglePreviewData() {
            toggleElement('previewInfo');
        }

        function initializeApp() {
            var urlParam = "";
            if (window.location.search.startsWith('?url=')) {
                urlParam = window.location.search.substring(5);
            }
            if (urlParam !== "") {
                console.log(urlParam);
                document.getElementById("sharedUrl").value = urlParam;
                previewUrlInfo(urlParam, true);
            }

            registerButtonHandlers();

            if (liff.isLoggedIn()) {
                toggleElement("liffLoginButton");
                toggleElement("liffLogoutButton");

                liff.getProfile()
                    .then(profile => {
                        userDisplayName = profile.displayName;
                        userPictureUrl = profile.pictureUrl;
                        document.getElementById('shareTargetPickerMessage').textContent = userDisplayName;
                    })
                    .catch(err => {
                        console.log('error:' + err);
                    });
            }
        }

        function registerButtonHandlers() {
            //get preview
            document.getElementById('getPreviewButton').addEventListener('click',
                function () {
                    var url = document.getElementById("sharedUrl").value;
                    previewUrlInfo(url);
                });

            document.getElementById('shareTargetPicker').addEventListener('click', function () {
                sendFlexMessage();
            });

            document.getElementById('directSendMessage').addEventListener('click', function () {
                directSendFlexMessage();
            });

            // login call, only when external browser is used
            document.getElementById('liffLoginButton').addEventListener('click', function () {
                if (!liff.isLoggedIn()) {
                    // set `redirectUri` to redirect the user to a URL other than the front page of your LIFF app.
                    liff.login();
                }
            });

            // logout call, only when external browser is used
            document.getElementById('liffLogoutButton').addEventListener('click', function () {
                if (!liff.isLoggedIn()) {
                    liff.logout();
                }
            });

        }

        window.onload = function () {
            const defaultLiffId = "1573344717-916lVwEz";

            // DO NOT CHANGE THIS
            let myLiffId = "";

            myLiffId = defaultLiffId;
            initializeLiffOrDie(myLiffId);

        }
    </script>
</body>
</html>